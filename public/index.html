<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unoapi Cloud — Manager</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- DataTables CSS -->
    <link href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.dataTables.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">

    <!-- Socket IO-->
    <script src="/socket.io.min.js" onerror="(function(){var s=document.createElement('script');s.src='https://cdn.jsdelivr.net/npm/socket.io-client@4.7.5/dist/socket.io.min.js';s.crossOrigin='anonymous';document.head.appendChild(s)})();"></script>
    <script>
      // Extra guard in case the browser blocked execution without firing onerror
      if (typeof window.io === 'undefined') {
        document.write('<' + 'script src="https://cdn.jsdelivr.net/npm/socket.io-client@4.7.5/dist/socket.io.min.js" crossorigin="anonymous"><' + '/script>')
      }
    </script>
    <style>
        :root { --bg:#0b0c0f; --fg:#e6e6e6; --muted:#9aa0a6; --link:#8ab4f8; --card:#15171c; --border:#222; --rowAlt:#12141a; }
        body[data-theme="light"] { --bg:#ffffff; --fg:#111827; --muted:#6b7280; --link:#1d4ed8; --card:#f3f4f6; --border:#e5e7eb; --rowAlt:#eef2f7; }

        body { margin:0; font: 15px/1.6 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, sans-serif; background:var(--bg); color:var(--fg); transition: background .2s ease, color .2s ease; min-height:100vh; display:flex; flex-direction:column; }

        .navbar { margin-bottom: 20px; background: var(--card) !important; border-bottom: 1px solid var(--border); }
        .navbar .navbar-brand, .navbar .nav-link { color: var(--fg) !important; }
        .navbar .btn { border:1px solid var(--border); background: var(--card); color: var(--fg); }
        .navbar-toggler { border-color: var(--border); }
        body:not([data-theme="light"]) .navbar-light .navbar-toggler-icon { filter: invert(1); }

        /* Header style (same as docs pages) */
        header { padding: 16px 24px; border-bottom: 1px solid var(--border); display:flex; align-items:center; justify-content:space-between; gap:16px; }
        .toolbar { display:flex; align-items:center; gap:12px; flex-wrap: nowrap; }
        .toolbar > * { flex: 0 0 auto; }
        .toolbar .btn, .toolbar select.btn { white-space: nowrap; }
        label.muted { display:flex; align-items:center; gap:6px; margin:0; }
        label.muted span { white-space: nowrap; }
        .muted { color: var(--muted); }
        /* Language select styled like other buttons */
        select.btn { appearance: none; -webkit-appearance: none; -moz-appearance: none; padding-right: 28px; background: var(--card); color: var(--fg); border:1px solid var(--border); border-radius:6px; cursor:pointer; font-size:14px; line-height:1.2; }
        header h1 { margin: 0 0 6px 0; font-size: 22px; }
        select.btn:focus { outline: 2px solid transparent; box-shadow: 0 0 0 2px rgba(100, 149, 237, .25); }
        @media (max-width: 900px) {
          header { flex-wrap: wrap; }
          header h1 { font-size: 18px; }
          .toolbar { width: 100%; justify-content: flex-start; flex-wrap: wrap; gap:8px; }
        }

        .edit-modal {
            max-width: 80vw;
        }

        .editForm {
            width: 80vw;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 52px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .d-none {
            display: none;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            -webkit-transition: .4s;
            transition: .4s;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 17px;
            width: 17px;
            left: 5px;
            bottom: 4px;
            background-color: white;
            -webkit-transition: .4s;
            transition: .4s;
        }

        input:checked + .slider {
            background-color: #2196F3;
        }

        input:focus + .slider {
            box-shadow: 0 0 1px #2196F3;
        }

        input:checked + .slider:before {
            -webkit-transform: translateX(26px);
            -ms-transform: translateX(26px);
            transform: translateX(26px);
        }

        .slider.round {
            border-radius: 34px;
        }

        .slider.round:before {
            border-radius: 50%;
        }

        .webhook {
            margin: 15px 45px;
            font-size: 14px;
            font-weight: 700;
        }

        .webhook:not(:last-child) {
            border-bottom: 1px solid var(--border);
            padding-bottom: 10px;
            margin: 10px 50px;
        }

        div#login {
            height: 100%;
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        a { color: var(--link); }
        a:hover { filter: brightness(1.1); }
        /* Base button style to match docs */
        .btn { appearance:none; border:1px solid var(--border); background: var(--card); color: var(--fg); border-radius:6px; padding:6px 10px; cursor:pointer; text-decoration:none; }
        .btn:hover { filter: brightness(1.08); }
        .btn:focus { outline: 2px solid transparent; box-shadow: 0 0 0 2px rgba(100,149,237,.25); }
        .btn:active { transform: translateY(1px); transition: transform .05s ease; }
        .btn[disabled], .btn.disabled { opacity: .6; cursor: not-allowed; }
        .btn svg { width:16px; height:16px; fill: currentColor; vertical-align: middle; }
        .modal-content { background: var(--card); color: var(--fg); border: 1px solid var(--border); }
        .modal-header, .modal-footer { border-color: var(--border); }
        .form-control, .form-select { background: var(--bg); color: var(--fg); border:1px solid var(--border); }
        .form-control::placeholder { color: var(--muted); }
        .table { color: var(--fg); border-color: var(--border) !important; background: var(--card); }
        .table thead th { border-bottom-color: var(--border) !important; }
        .table-striped > tbody > tr:nth-of-type(odd) { --bs-table-accent-bg: var(--rowAlt); color: var(--fg); }
        .dropdown-menu { background: var(--card); color: var(--fg); border: 1px solid var(--border); }
        .dropdown-item { color: var(--fg); }
        .dropdown-item:hover { background: var(--rowAlt); }

        /* Buttons palette harmonized with theme */
        .btn-primary { background: var(--link) !important; border-color: var(--link) !important; color: #fff !important; }
        .btn-primary:hover { filter: brightness(1.08); }
        .btn-secondary { background: var(--rowAlt) !important; border-color: var(--border) !important; color: var(--fg) !important; }
        .btn-secondary:hover { filter: brightness(1.05); }
        .btn-dark { background: var(--border) !important; border-color: var(--border) !important; color: var(--fg) !important; }
        .btn-dark:hover { filter: brightness(1.1); }
        .btn-outline-primary { background: transparent !important; color: var(--link) !important; border-color: var(--link) !important; }
        .btn-outline-primary:hover { background: var(--link) !important; color: #fff !important; }

        /* Pagination (DataTables/Bootstrap) */
        .page-link { background: var(--card); color: var(--fg); border-color: var(--border); }
        .page-link:hover { background: var(--rowAlt); color: var(--fg); }
        .page-item.active .page-link { background: var(--link); border-color: var(--link); color: #fff; }

        .container {
            display: flex;
            flex-direction: column;
            justify-content: space-evenly;
            align-items: stretch;
        }
        #tokenForm {
            display: flex;
            flex-direction: column;
            width: 100%;
            padding: 0 25%;
            font-size: 25px;
            font-weight: bold;
        }

        .edit-form-row {
            margin-bottom: 15px;
        }

        :root {
            --bs-breakpoint-xs: 0;        
            --bs-breakpoint-sm: 480px;    
            --bs-breakpoint-md: 768px;    
            --bs-breakpoint-lg: 1024px;  
            --bs-breakpoint-xl: 1300px;
            --bs-breakpoint-xxl: 1560px;
        }
        .form-label {
            margin-top: 10px;
            margin-bottom: -10px;
        }
        /* Ajustes de responsividade */
        @media (max-width: 992px) {
          .navbar .btn { padding: 4px 10px; }
        }
        @media (max-width: 768px) {
          #tokenForm { padding: 0 12px; font-size: 18px; }
          .editForm { width: 100%; }
          .webhook { margin: 10px 12px; }
          .webhook:not(:last-child) { margin: 10px 12px; }
        }

        /* Markdown theme overrides (match Docs) */
        .markdown-body { color: var(--fg) !important; background: transparent !important; }
        .markdown-body pre,
        .markdown-body code { background: var(--bg) !important; color: var(--fg) !important; border: 1px solid var(--border) !important; }
        .markdown-body hr { border-color: var(--border) !important; }
        .markdown-body h1,
        .markdown-body h2,
        .markdown-body h3,
        .markdown-body h4,
        .markdown-body h5,
        .markdown-body h6 { color: var(--fg) !important; }
        .markdown-body a { color: var(--link) !important; }

        /* DataTables theme overrides */
        .dataTables_wrapper { color: var(--fg); }
        .dataTables_wrapper .dataTables_length label,
        .dataTables_wrapper .dataTables_filter label { color: var(--fg); }
        .dataTables_wrapper .dataTables_length select,
        .dataTables_wrapper .dataTables_filter input { background: var(--bg) !important; color: var(--fg) !important; border: 1px solid var(--border) !important; border-radius: 6px; }
        .dataTables_wrapper .dataTables_filter input::placeholder { color: var(--muted); }
        .dataTables_wrapper .dataTables_info { color: var(--muted); }
        .dataTables_wrapper .dataTables_paginate .paginate_button { background: var(--card) !important; color: var(--fg) !important; border: 1px solid var(--border) !important; border-radius: 6px; padding: 4px 8px; margin: 0 2px; }
        .dataTables_wrapper .dataTables_paginate .paginate_button:hover { background: var(--rowAlt) !important; color: var(--fg) !important; border-color: var(--border) !important; }
        .dataTables_wrapper .dataTables_paginate .paginate_button.current { background: var(--link) !important; border-color: var(--link) !important; color: #fff !important; }
        .dataTables_wrapper .dataTables_paginate .paginate_button.disabled { opacity: .6; background: var(--card) !important; color: var(--muted) !important; }
        .dataTables_wrapper .dataTables_processing { background: var(--card); color: var(--fg); border: 1px solid var(--border); }

        table.dataTable thead th, table.dataTable thead td { color: var(--fg) !important; background: var(--card) !important; border-bottom: 1px solid var(--border) !important; }
        table.dataTable tbody tr { background: var(--card) !important; }
        table.dataTable.stripe tbody tr.odd,
        table.dataTable.display tbody tr.odd { background-color: var(--rowAlt) !important; }
        table.dataTable.hover tbody tr:hover,
        table.dataTable.display tbody tr:hover { background-color: var(--rowAlt) !important; }
        table.dataTable.no-footer { border-bottom: 1px solid var(--border) !important; }

        /* Responsive extension: control icon + child row */
        table.dataTable.dtr-inline.collapsed>tbody>tr>td:first-child:before,
        table.dataTable.dtr-inline.collapsed>tbody>tr>th:first-child:before {
          background-color: var(--link) !important; color: #fff !important; border: 1px solid var(--border) !important;
          box-shadow: none !important;
        }
        table.dataTable>tbody>tr.child { background: var(--card) !important; }
        table.dataTable>tbody>tr.child:hover { background: var(--rowAlt) !important; }
        table.dataTable>tbody>tr.child .dtr-details { color: var(--fg); }
        table.dataTable>tbody>tr.child .dtr-details>li { border-bottom: 1px solid var(--border); }
        table.dataTable>tbody>tr.child .dtr-title { color: var(--muted); }

        /* Mobile tweaks for actions column */
        @media (max-width: 768px) {
          #sessionsTable td:last-child { white-space: normal; }
          #sessionsTable .btn { margin-bottom: 6px; }
        }

        /* Status badge */
        .status { display:inline-flex; align-items:center; gap:6px; font-weight:600; }
        .status .dot { width:10px; height:10px; border-radius:50%; display:inline-block; box-shadow: 0 0 0 1px rgba(0,0,0,.15) inset; }
        .status-online { color: #22c55e; }
        .status-online .dot { background:#22c55e; }
        .status-offline { color: #ef4444; }
        .status-offline .dot { background:#ef4444; }
        .status-connecting { color: #f59e0b; }
        .status-connecting .dot { background:#f59e0b; }
        .status-standby { color: #a855f7; }
        .status-standby .dot { background:#a855f7; }
        .status-disconnected { color: #9ca3af; }
        .status-disconnected .dot { background:#9ca3af; }
        .status-restart_required { color: #f43f5e; }
        .status-restart_required .dot { background:#f43f5e; }

    </style>
</head>
<body>
    <script>
      function setTheme(theme) {
        document.body.setAttribute('data-theme', theme);
        try { localStorage.setItem('unoapi_docs_theme', theme) } catch {}
      }
      // i18n
      var currentLang = 'en';
      var I18N = {
        'en': {
          langLabel: 'Language:',
          headerTitle: 'Unoapi Cloud — Manager',
          headerSub: 'Manage sessions and quick tests',
          docsLink: 'Docs',
          themeButton: 'Toggle Theme',
          menuAddInstance: 'Add Instance',
          menuLogout: 'Logout',
          configuredToken: 'Configured token:',
          tokenPlaceholder: 'Enter your token',
          connect: 'Connect',
          errorInvalid: 'Error: Invalid token or connection failed.',
          thLabel: 'Label', thNumber: 'Number', thStatus: 'Status', thServer: 'Server', thActions: 'Actions',
          addSessionTitle: 'Add Session', connectionNumber: 'Connection Number', connectionNumberPh: 'Number format: 55 DDD NUMBER', configure: 'Configure',
          editAddTitle: 'Edit/Add Session',
          connectSession: 'Connect Session', qrWait: 'Wait for the QRCode/PairingCode event', qrWillAppear: 'QRCode/PairingCode will appear here',
          testSession: 'Test Session', recipient: 'Recipient WhatsApp', recipientPh: 'Number format: 55 DDD NUMBER', textMessage: 'Text message', send: 'Send',
          qrScanBelow: 'Scan the QR Code below', qrWaitingNew: 'Waiting for a new QRCode/PairingCode', connected: 'Connected!',
          fldLabel: 'Label', fldLabelPh: 'Label',
          rejectCallsWebhookLabel: 'Incoming/Rejected Call Message', rejectCallsWebhookPh: 'I was calling you...',
          connectionType: 'Connection Type', proxyUrlLabel: 'Proxy URL (Restart Unoapi after change)', proxyUrlPh: 'Ex: socks5://user:pass@host:port',
          rejectCallsLabel: 'Message when rejecting calls', rejectCallsPh: 'Leave blank to not auto-reject calls', serverLabel: 'Server',
          ignoreGroupMessages: 'Ignore Group Messages', ignoreNewsletterMessages: 'Ignore Newsletter Messages', ignoreHistoryMessages: 'Ignore Message History',
          readOnReceipt: 'Mark as read on receive', sendProfilePicture: 'Send Profile Picture', ignoreStatuses: 'Ignore Status', sendConnStatus: 'Send Connection Status',
          notifyFailures: 'Notify Failures', sendTyping: 'Send "Typing"', sendReactionAsReply: 'Send Reaction As Reply', ignoreOwnMessages: 'Ignore Own Messages', ignoreYourselfMessages: 'Ignore Yourself Messages', autoConnect: 'Auto Connect', ignoreBroadcastMessages: 'Ignore Broadcast Lists',
          whId: 'ID', whIdPh: 'Webhook ID', whUrlAbs: 'Absolute URL', whUrlAbsPh: 'Webhook Absolute URL', whToken: 'Token', whTokenPh: 'Webhook Token', whHeader: 'Header', whHeaderPh: 'Webhook Header',
          whSendNew: 'Send New Messages', whSendGroup: 'Send Group Messages', whSendNewsletter: 'Send Newsletter Messages', whSendOutgoing: 'Send Outgoing Messages', whSendIncoming: 'Send Incoming Messages', whSendUpdate: 'Send Message Updates', whSendTranscribe: 'Send Audio Transcription', whAddBlacklist: 'Add to blacklist when there is an outgoing message for X seconds', remove: 'Remove',
          btnEdit: 'Edit', btnConnect: 'Connect', btnDelete: 'Delete', btnTest: 'Test',
          confirmDelete: 'Are you sure you want to delete this session?',
          apiNoQr: 'API did not generate the QR Code.', tokenNotFound: 'Token not found.',
          rateTitle: 'Anti-spam / Rate Limits',
          rateGlobal: 'Global per minute (per session)',
          rateGlobalPh: '0 = disabled',
          ratePerTo: 'Per-destination per minute',
          ratePerToPh: '0 = disabled',
          rateBlock: 'Block seconds when exceeded',
          rateBlockPh: '60',
          groqApiKeyLabel: 'Groq API Key',
          groqApiKeyPh: 'Groq API Key',
          groqApiTranscribeModelLabel: 'Groq Transcribe Model',
          groqApiTranscribeModelPh: 'e.g. whisper-large-v3',
          groqApiBaseUrlLabel: 'Groq API Base URL',
          groqApiBaseUrlPh: 'https://api.groq.com/openai/v1'
        },
        'pt-BR': {
          langLabel: 'Idioma:',
          headerTitle: 'Unoapi Cloud — Manager',
          headerSub: 'Gerencie sessões e testes rápidos',
          docsLink: 'Documentação',
          themeButton: 'Alternar tema',
          menuAddInstance: 'Adicionar Instância',
          menuLogout: 'Sair',
          configuredToken: 'Token configurado:',
          tokenPlaceholder: 'Insira o token aqui',
          connect: 'Conectar',
          errorInvalid: 'Erro: Token inválido ou conexão falhou.',
          thLabel: 'Identificação', thNumber: 'Número', thStatus: 'Status', thServer: 'Server', thActions: 'Ações',
          addSessionTitle: 'Adicionar Sessão', connectionNumber: 'Número da Conexão', connectionNumberPh: 'Número no formato 55 DDD NÚMERO', configure: 'Configurar',
          editAddTitle: 'Editar/Adicionar Sessão',
          connectSession: 'Conectar Sessão', qrWait: 'Aguarde o evento com o QrCode/PairingCode', qrWillAppear: 'QrCode/PairingCode será exibido aqui',
          testSession: 'Testar Sessão', recipient: 'Whatsapp Destinatário', recipientPh: 'Número no formato 55 DDD NÚMERO', textMessage: 'Mensagem em texto', send: 'Enviar',
          qrScanBelow: 'Leia o QR Code Abaixo', qrWaitingNew: 'Esperando um novo QrCode/PairingCode', connected: 'Conectado!',
          fldLabel: 'Identificação', fldLabelPh: 'Identificação',
          rejectCallsWebhookLabel: 'Mensagem de Ligação Recebida e/ou Rejeitada', rejectCallsWebhookPh: 'Estava te ligando...',
          connectionType: 'Tipo de Conexão', proxyUrlLabel: 'Proxy Url (Precisa Reiniciar a Unoapi ao Alterar)', proxyUrlPh: 'Ex: socks5://user:pass@ip/domain:port',
          rejectCallsLabel: 'Mensagem ao Rejeitar Chamadas', rejectCallsPh: 'Deixe em Branco para não Rejeitar ligações automaticamente', serverLabel: 'Server',
          ignoreGroupMessages: 'Ignorar Mensagens de Grupo', ignoreNewsletterMessages: 'Ignorar Mensagens de Newsletter', ignoreHistoryMessages: 'Ignorar Histórico de Mensagens',
          readOnReceipt: 'Ler a mensagem ao receber', sendProfilePicture: 'Enviar Foto de Perfil', ignoreStatuses: 'Ignorar Status', sendConnStatus: 'Enviar Status da Conexão',
          notifyFailures: 'Notificar Falhas', sendTyping: 'Enviar "Digitando"', sendReactionAsReply: 'Enviar Reação Como Resposta', ignoreOwnMessages: 'Ignorar Mensagens Próprias', ignoreYourselfMessages: 'Ignorar Suas Mensagens', autoConnect: 'Conexão Automática', ignoreBroadcastMessages: 'Ignorar Listas de Transmissão',
          whId: 'ID', whIdPh: 'ID do Webhook', whUrlAbs: 'URL Absoluta', whUrlAbsPh: 'URL Absoluta do Webhook', whToken: 'Token', whTokenPh: 'Token do Webhook', whHeader: 'Header', whHeaderPh: 'Header do Webhook',
          whSendNew: 'Enviar Novas Mensagens', whSendGroup: 'Enviar Mensagens de Grupos', whSendNewsletter: 'Enviar Mensagens de Newsletter', whSendOutgoing: 'Enviar Mensagens de Saída', whSendIncoming: 'Enviar Mensagens de Entrada', whSendUpdate: 'Enviar Atualização de Mensagens', whSendTranscribe: 'Enviar Transcrição de Áudio', whAddBlacklist: 'Adicionar ao blacklist quando houver mensagem de saída por X segundos', remove: 'Remover',
          btnEdit: 'Editar', btnConnect: 'Conectar', btnDelete: 'Deletar', btnTest: 'Testar',
          confirmDelete: 'Tem certeza que deseja deletar essa sessão?',
          apiNoQr: 'API não gerou o QRCODE.', tokenNotFound: 'Token não encontrado.',
          rateTitle: 'Anti-spam / Limites',
          rateGlobal: 'Global por minuto (por sessão)',
          rateGlobalPh: '0 = desativado',
          ratePerTo: 'Por destinatário por minuto',
          ratePerToPh: '0 = desativado',
          rateBlock: 'Segundos de bloqueio ao exceder',
          rateBlockPh: '60',
          groqApiKeyLabel: 'Chave da API Groq',
          groqApiKeyPh: 'Chave da API Groq',
          groqApiTranscribeModelLabel: 'Modelo de Transcrição (Groq)',
          groqApiTranscribeModelPh: 'ex.: whisper-large-v3',
          groqApiBaseUrlLabel: 'URL Base da API Groq',
          groqApiBaseUrlPh: 'https://api.groq.com/openai/v1'
        }
      };
      function t(key){ var d=I18N[currentLang]||I18N['en']; return d[key]||key }
      function applyI18n(){
        document.querySelectorAll('[data-i18n]').forEach(function(el){ el.textContent = t(el.getAttribute('data-i18n')) })
        document.querySelectorAll('[data-i18n-placeholder]').forEach(function(el){ el.setAttribute('placeholder', t(el.getAttribute('data-i18n-placeholder'))) })
        document.querySelectorAll('[data-i18n-title]').forEach(function(el){ el.setAttribute('title', t(el.getAttribute('data-i18n-title'))) })
      }
      (function() {
        const saved = (localStorage.getItem('unoapi_docs_theme') || '').toLowerCase();
        const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        setTheme(saved || (prefersDark ? 'dark' : 'light'));
        window.addEventListener('DOMContentLoaded', function() {
          function reinitDataTableLang() {
            if (window.$ && window.$.fn && window.$.fn.dataTable && window.$.fn.dataTable.isDataTable('#sessionsTable')) {
              try { $('#sessionsTable').DataTable().destroy(); } catch {}
              $('#sessionsTable').empty().append(`
                <thead>
                  <tr>
                    <th data-i18n="thLabel">${t('thLabel')}</th>
                    <th data-i18n="thNumber">${t('thNumber')}</th>
                    <th data-i18n="thStatus">${t('thStatus')}</th>
                    <th data-i18n="thServer">${t('thServer')}</th>
                    <th data-i18n="thActions">${t('thActions')}</th>
                  </tr>
                </thead>
                <tbody></tbody>
              `);
              const token = localStorage.getItem(tokenKey);
              if (token && typeof fetchSessions === 'function') { fetchSessions(token, false); }
            }
          }
          // language setup
          try {
            const savedLang = localStorage.getItem('unoapi_docs_lang') || ''
            if (savedLang === 'pt-BR' || savedLang === 'en') { currentLang = savedLang }
          } catch {}
          var sel = document.getElementById('lang'); if (sel) { sel.value = currentLang; sel.addEventListener('change', function(){ currentLang = sel.value; try { localStorage.setItem('unoapi_docs_lang', currentLang) } catch {}; applyI18n(); reinitDataTableLang(); }) }
          applyI18n()
          var btn = document.getElementById('toggle-theme');
          if (btn) {
            btn.addEventListener('click', function() {
              const next = document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
              setTheme(next);
            });
          }
          // Re-init datatable on language change if needed
          // If table already existed (page restored), ensure it matches current language
          reinitDataTableLang();
        });
      })();
    </script>
    <!-- Header (unified with docs) -->
    <header>
      <div style="display:flex;align-items:center;gap:12px;">
        <img src="/logos/unoapi_logo.png" alt="Unoapi" style="height:44px;width:auto;"/>
        <div>
          <h1 style="margin:0;font-size:20px;" data-i18n="headerTitle">Unoapi Cloud — Manager</h1>
          <p class="muted" style="margin:0;" data-i18n="headerSub">Manage sessions and quick tests</p>
        </div>
      </div>
      <div class="toolbar">
        <label class="muted"><span data-i18n="langLabel">Language:</span>
          <select id="lang" class="btn">
            <option value="en">English</option>
            <option value="pt-BR">Português (Brasil)</option>
          </select>
        </label>
        <a id="docs-link" class="btn" href="/docs" data-i18n="docsLink">Docs</a>
        <button id="toggle-theme" class="btn" data-i18n="themeButton" title="Toggle theme">Toggle Theme</button>
        <!-- Settings dropdown (restored) -->
        <div class="dropdown d-none" id="navbarDropdown">
          <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" title="Settings">
            <i class="fa-solid fa-gear" aria-hidden="true"></i>
          </button>
          <ul class="dropdown-menu dropdown-menu-end">
            <li>
              <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#addInstanceModal" data-i18n="menuAddInstance">Add Instance</a>
            </li>
            <li><hr class="dropdown-divider"></li>
            <li>
              <a class="dropdown-item" href="#" onclick="logout();" data-i18n="menuLogout">Logout</a>
            </li>
          </ul>
        </div>
        <a class="btn" href="https://github.com/clairton/unoapi-cloud" target="_blank" rel="noopener" title="GitHub">
          <svg aria-hidden="true" viewBox="0 0 16 16"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"></path></svg>
        </a>
      </div>
    </header>

    <div id="login">
        <div id="tokenForm" class="mb-4">
            <label for="tokenInput" class="form-label mb-2" data-i18n="configuredToken">Configured token:</label>
            <div class="input-group mb-3">
                <input type="text" id="tokenInput" class="form-control" placeholder="Enter your token" data-i18n-placeholder="tokenPlaceholder" aria-describedby="connectButton">
                <button class="btn btn-dark" type="button" id="connectButton" data-i18n="connect"><i class="fas fa-sign-in"></i> Connect</button>
            </div>
        </div>
        <p id="errorMessage" class="text-danger d-none" data-i18n="errorInvalid">Error: Invalid token or connection failed.</p>
    </div>
    <div class="container mt-4">
        <table id="sessionsTable" class="table table-striped table-bordered d-none" style="width: 100%;">
            <thead>
                <tr>
                    <th data-i18n="thLabel">Label</th>
                    <th data-i18n="thNumber">Number</th>
                    <th data-i18n="thStatus">Status</th>
                    <th data-i18n="thServer">Server</th>
                    <th data-i18n="thActions">Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- Modal para adicionar instância -->
    <div class="modal fade" id="addInstanceModal" tabindex="-1" aria-labelledby="addInstanceModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addInstanceModalLabel" data-i18n="addSessionTitle">Add Session</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addInstanceForm">
                        <div class="mb-3">
                            <label for="instanceNumber" class="form-label" data-i18n="connectionNumber">Connection Number</label>
                            <input type="number" class="form-control" id="instanceNumber" placeholder="Number format: 55 DDD NUMBER" data-i18n-placeholder="connectionNumberPh" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="submitInstanceNumber()" data-i18n="configure">Configure</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Editar -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
        <div class="modal-dialog edit-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editModalLabel" data-i18n="editAddTitle">Edit/Add Session</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editForm">
                        <div class="row edit-form-row">
                          <div class="col-12 col-md-12 col-lg-6">
                              <label for="label" class="form-label" data-i18n="fldLabel">Label</label>
                              <input type="text" class="form-control" id="label" name="lavel" placeholder="Label" data-i18n-placeholder="fldLabelPh">
                          </div>
                            <div class="col-12 col-md-12 col-lg-6">
                                <label for="authToken" class="form-label">Auth Token</label>
                                <input type="text" class="form-control" id="authToken" name="authToken" placeholder="Auth Token">
                            </div>
                            <div class="col-12 col-md-12 col-lg-6">
                                <label for="openaiApiKey" class="form-label">Openai Api Key</label>
                                <input type="text" class="form-control" id="openaiApiKey" name="openaiApiKey" placeholder="Openai Api Key">
                            </div>
                            <div class="col-12 col-md-12 col-lg-6">
                                <label for="openaiApiTranscribeModel" class="form-label">Openai Transcribe Model</label>
                                <input type="text" class="form-control" id="openaiApiTranscribeModel" name="openaiApiTranscribeModel" placeholder="Openai Transcribe Model">
                            </div>
                            <div class="col-12 col-md-12 col-lg-6">
                                <label for="groqApiKey" class="form-label" data-i18n="groqApiKeyLabel">Groq API Key</label>
                                <input type="text" class="form-control" id="groqApiKey" name="groqApiKey" placeholder="Groq API Key" data-i18n-placeholder="groqApiKeyPh">
                            </div>
                            <div class="col-12 col-md-12 col-lg-6">
                                <label for="groqApiTranscribeModel" class="form-label" data-i18n="groqApiTranscribeModelLabel">Groq Transcribe Model</label>
                                <input type="text" class="form-control" id="groqApiTranscribeModel" name="groqApiTranscribeModel" placeholder="e.g. whisper-large-v3" data-i18n-placeholder="groqApiTranscribeModelPh">
                            </div>
                            <div class="col-12 col-md-12 col-lg-6">
                                <label for="groqApiBaseUrl" class="form-label" data-i18n="groqApiBaseUrlLabel">Groq API Base URL</label>
                                <input type="text" class="form-control" id="groqApiBaseUrl" name="groqApiBaseUrl" placeholder="https://api.groq.com/openai/v1" data-i18n-placeholder="groqApiBaseUrlPh">
                            </div>
                            <div class="col-12 col-md-12 col-lg-6">
                                <label for="wavoipToken" class="form-label">Wavoip Token</label>
                                <input type="text" class="form-control" id="wavoipToken" name="wavoipToken" placeholder="WAVOIP token">
                            </div>
                            <div class="col-12 col-md-12 col-lg-6">
                                <label for="rejectCallsWebhook" class="form-label" data-i18n="rejectCallsWebhookLabel">Incoming/Rejected Call Message</label>
                                <input type="text" class="form-control" id="rejectCallsWebhook" name="rejectCallsWebhook" placeholder="I was calling you..." data-i18n-placeholder="rejectCallsWebhookPh">
                            </div>
                            <div class="col-12 col-md-12 col-lg-6">
                              <label for="connectionType" class="form-label" data-i18n="connectionType">Connection Type</label>
                              <select id="connectionType" name="connectionType" class="form-control">
                                <option value="qrcode" selected>QrCode</option>
                                <option value="pairing_code">PairingCode</option>
                                <option value="forward">Forward</option>
                              </select>
                            </div>
                            <div class="col-12 col-md-12 col-lg-6">
                                <label for="proxyUrl" class="form-label" data-i18n="proxyUrlLabel">Proxy URL (Restart Unoapi after change)</label>
                                <input type="text" class="form-control" id="proxyUrl" name="proxyUrl" placeholder="Ex: socks5://user:pass@host:port" data-i18n-placeholder="proxyUrlPh">
                            </div>
                            <div class="col-12 col-md-12 col-lg-6">
                              <label for="rejectCalls" class="form-label" data-i18n="rejectCallsLabel">Message when rejecting calls</label>
                              <textarea class="form-control" id="rejectCalls" name="rejectCalls" placeholder="Leave blank to not auto-reject calls" data-i18n-placeholder="rejectCallsPh" oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'"></textarea>
                            </div>
                            <div class="col-12 col-md-12 col-lg-6">
                              <label for="server" class="form-label" data-i18n="serverLabel">Server</label>
                                <input type="text" class="form-control" id="server" name="server" placeholder="Ex: default is server_1">
                            </div>
                        </div>
                        <div class="row edit-form-row">
                            <div class="col-12 col-md-6 col-lg-6 col-xl-4 col-xxl-3">
                                <label class="switch">
                                    <input type="checkbox" id="ignoreGroupMessages" name="ignoreGroupMessages" checked>
                                    <span class="slider round"></span>
                                </label>
                                <label for="ignoreGroupMessages" class="form-label" data-i18n="ignoreGroupMessages">Ignore Group Messages</label>
                            </div>
                            <div class="col-12 col-md-6 col-lg-6 col-xl-4 col-xxl-3">
                                <label class="switch">
                                    <input type="checkbox" id="ignoreNewsletterMessages" name="ignoreNewsletterMessages" checked>
                                    <span class="slider round"></span>
                                </label>
                                <label for="ignoreNewsletterMessages" class="form-label" data-i18n="ignoreNewsletterMessages">Ignore Newsletter Messages</label>
                            </div>
                            <div class="col-12 col-md-6 col-lg-6 col-xl-4 col-xxl-3">
                                <label class="switch">
                                    <input type="checkbox" id="ignoreHistoryMessages" name="ignoreHistoryMessages" checked>
                                    <span class="slider round"></span>
                                </label>
                                <label for="ignoreHistoryMessages" class="form-label" data-i18n="ignoreHistoryMessages">Ignore Message History</label>
                            </div>
                            <div class="col-12 col-md-6 col-lg-6 col-xl-4 col-xxl-3">
                                <label class="switch">
                                    <input type="checkbox" id="readOnReceipt" name="readOnReceipt" checked>
                                    <span class="slider round"></span>
                                </label>
                                <label for="readOnReceipt" class="form-label" data-i18n="readOnReceipt">Mark as read on receive</label>
                            </div>
                            <div class="col-12 col-md-6 col-lg-6 col-xl-4 col-xxl-3">
                                <label class="switch">
                                    <input type="checkbox" id="sendProfilePicture" name="sendProfilePicture">
                                    <span class="slider round"></span>
                                </label>
                                <label for="sendProfilePicture" class="form-label" data-i18n="sendProfilePicture">Send Profile Picture</label>
                            </div>
                            <div class="col-12 col-md-6 col-lg-6 col-xl-4 col-xxl-3">
                                <label class="switch">
                                    <input type="checkbox" id="ignoreBroadcastStatuses" name="ignoreBroadcastStatuses" checked>
                                    <span class="slider round"></span>
                                </label>
                                <label for="ignoreBroadcastStatuses" class="form-label" data-i18n="ignoreStatuses">Ignore Status</label>
                            </div>
                            <div class="col-12 col-md-6 col-lg-6 col-xl-4 col-xxl-3">
                                <label class="switch">
                                    <input type="checkbox" id="sendConnectionStatus" name="sendConnectionStatus">
                                    <span class="slider round"></span>
                                </label>
                                <label for="sendConnectionStatus" class="form-label" data-i18n="sendConnStatus">Send Connection Status</label>
                            </div>
                            <div class="col-12 col-md-6 col-lg-6 col-xl-4 col-xxl-3">
                                <label class="switch">
                                    <input type="checkbox" id="notifyFailedMessages" name="notifyFailedMessages">
                                    <span class="slider round"></span>
                                </label>
                                <label for="notifyFailedMessages" class="form-label" data-i18n="notifyFailures">Notify Failures</label>
                            </div>
                            <div class="col-12 col-md-6 col-lg-6 col-xl-4 col-xxl-3">
                                <label class="switch">
                                    <input type="checkbox" id="composingMessage" name="composingMessage">
                                    <span class="slider round"></span>
                                </label>
                                <label for="composingMessage" class="form-label" data-i18n="sendTyping">Send "Typing"</label>
                            </div>
                            <div class="col-12 col-md-6 col-lg-6 col-xl-4 col-xxl-3">
                                <label class="switch">
                                    <input type="checkbox" id="sendReactionAsReply" name="sendReactionAsReply">
                                    <span class="slider round"></span>
                                </label>
                                <label for="sendReactionAsReply" class="form-label" data-i18n="sendReactionAsReply">Send Reaction As Reply</label>
                            </div>
                            <div class="col-12 col-md-6 col-lg-6 col-xl-4 col-xxl-3">
                                <label class="switch">
                                    <input type="checkbox" id="ignoreOwnMessages" name="ignoreOwnMessages">
                                    <span class="slider round"></span>
                                </label>
                                <label for="ignoreOwnMessages" class="form-label" data-i18n="ignoreOwnMessages">Ignore Own Messages</label>
                            </div>
                            <div class="col-12 col-md-6 col-lg-6 col-xl-4 col-xxl-3">
                                <label class="switch">
                                    <input type="checkbox" id="ignoreYourselfMessages" name="ignoreYourselfMessages">
                                    <span class="slider round"></span>
                                </label>
                                <label for="ignoreYourselfMessages" class="form-label" data-i18n="ignoreYourselfMessages">Ignore Yourself Messages</label>
                            </div>
                            <div class="col-12 col-md-6 col-lg-6 col-xl-4 col-xxl-3">
                                <label class="switch">
                                    <input type="checkbox" id="autoConnect" name="autoConnect" checked>
                                    <span class="slider round"></span>
                                </label>
                                <label for="autoConnect" class="form-label" data-i18n="autoConnect">Auto Connect</label>
                            </div>
                            <div class="col-12 col-md-6 col-lg-6 col-xl-4 col-xxl-3">
                                <label class="switch">
                                    <input type="checkbox" id="ignoreBroadcastMessages" name="ignoreBroadcastMessages" checked>
                                    <span class="slider round"></span>
                                </label>
                                <label for="ignoreBroadcastMessages" class="form-label" data-i18n="ignoreBroadcastMessages">Ignore Broadcast Lists</label>
                            </div>
                            <!-- Anti-spam / Rate Limits -->
                            <div class="col-12">
                              <hr>
                              <h6 data-i18n="rateTitle">Anti-spam / Rate Limits</h6>
                            </div>
                            <div class="col-12 col-md-6 col-lg-4">
                              <label for="rateLimitGlobalPerMinute" class="form-label" data-i18n="rateGlobal">Global per minute (per session)</label>
                              <input type="number" min="0" class="form-control" id="rateLimitGlobalPerMinute" placeholder="0" data-i18n-placeholder="rateGlobalPh">
                            </div>
                            <div class="col-12 col-md-6 col-lg-4">
                              <label for="rateLimitPerToPerMinute" class="form-label" data-i18n="ratePerTo">Per-destination per minute</label>
                              <input type="number" min="0" class="form-control" id="rateLimitPerToPerMinute" placeholder="0" data-i18n-placeholder="ratePerToPh">
                            </div>
                            <div class="col-12 col-md-6 col-lg-4">
                              <label for="rateLimitBlockSeconds" class="form-label" data-i18n="rateBlock">Block seconds when exceeded</label>
                              <input type="number" min="0" class="form-control" id="rateLimitBlockSeconds" placeholder="60" data-i18n-placeholder="rateBlockPh">
                            </div>
                        </div>
                        <div id="webhooksContainer">
                            <h6>Webhooks</h6>
                            <div class="webhook mb-3">
                                <label for="webhookId" class="form-label">ID</label>
                                <input type="text" class="form-control mb-2 webhook-id" placeholder="Webhook ID">
                                <label for="webhookUrl" class="form-label">URL Absoluta</label>
                                <input type="text" class="form-control mb-2 webhook-url" placeholder="Webhook URL Absoluta">
                                <label for="webhookToken" class="form-label">Token</label>
                                <input type="text" class="form-control mb-2 webhook-token" placeholder="Webhook Token">
                                <label for="webhookHeader" class="form-label">Header</label>
                                <input type="text" class="form-control mb-2 webhook-header" placeholder="Webhook Header">
                                <label for="sendNewMessages" class="form-label">Enviar Novas Mensagens</label>
                                <label class="switch">
                                    <input type="checkbox" class="webhook-sendNewMessages">
                                    <span class="slider round"></span>
                                </label>
                                <label for="sendGroupMessages" class="form-label">Enviar Mensagens de Grupos</label>
                                <label class="switch">
                                    <input type="checkbox" class="webhook-sendGroupMessages">
                                    <span class="slider round"></span>
                                </label>
                                <label for="sendNewsletterMessages" class="form-label">Enviar Mensagens de Newsletter</label>
                                <label class="switch">
                                    <input type="checkbox" class="webhook-sendNewsletterMessages">
                                    <span class="slider round"></span>
                                </label>
                                <label for="sendOutgoingMessages" class="form-label">Enviar Mensagens de Saída</label>
                                <label class="switch">
                                    <input type="checkbox" class="webhook-sendOutgoingMessages">
                                    <span class="slider round"></span>
                                </label>
                                <label for="sendIncomingMessages" class="form-label">Enviar Mensagens de Entrada</label>
                                <label class="switch">
                                    <input type="checkbox" class="webhook-sendIncomingMessages">
                                    <span class="slider round"></span>
                                </label>
                                <label for="sendUpdateMessages" class="form-label">Enviar Atualização de Mensagens</label>
                                <label class="switch">
                                    <input type="checkbox" class="webhook-sendUpdateMessages">
                                    <span class="slider round"></span>
                                </label>
                                <label for="sendTranscribeAudio" class="form-label">Enviar Transcrição de Áudio</label>
                                <label class="switch">
                                    <input type="checkbox" class="webhook-sendTranscribeAudio">
                                    <span class="slider round"></span>
                                </label>
                                <label for="addToBlackListOnOutgoingMessageWithTtl" class="form-label">Adicionar ao blacklits quando ouver uma mensagem de saida por X segundos</label>
                                <label>
                                    <input type="text" class="webhook-addToBlackListOnOutgoingMessageWithTtl" class="form-control">
                                </label>
                                <button type="button" class="btn btn-danger btn-sm mt-2 remove-webhook">Remover</button>
                            </div>
                        </div>
                        <button type="button" id="addWebhookButton" class="btn btn-secondary btn-sm">Adicionar Webhook</button>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="saveEditButton">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Conectar -->
    <div class="modal fade" id="connectModal" tabindex="-1" aria-labelledby="connectModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="connectModalLabel" data-i18n="connectSession">Connect Session</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <p id="qrCodeMessage" data-i18n="qrWait">Wait for the QRCode/PairingCode event</p>
                    <div id="qrCodeContainer" data-i18n="qrWillAppear">QRCode/PairingCode will appear here</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Mensagem -->
    <div class="modal fade" id="messageModal" tabindex="-1" aria-labelledby="messageModalLabel" aria-hidden="true">
      <div class="modal-dialog">
          <div class="modal-content">
              <div class="modal-header">
                  <h5 class="modal-title" id="messageModalLabel" data-i18n="testSession">Test Session</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                  <form id="messageModalForm">
                    <div class="mb-3">
                        <label for="messageModalNumber" class="form-label" data-i18n="recipient">Recipient WhatsApp</label>
                        <input type="number" class="form-control" id="messageModalNumber" placeholder="Number format: 55 DDD NUMBER" data-i18n-placeholder="recipientPh" required>
                    </div>
                      <div class="mb-3">
                          <label for="messageModalText" class="form-label" data-i18n="textMessage">Text message</label>
                          <input type="text" class="form-control" id="messageModalText" placeholder="" required>
                      </div>
                  </form>
              </div>
              <div class="modal-footer">
                  <button type="button" class="btn btn-primary" onclick="submitMessage()" data-i18n="send">Send</button>
              </div>
          </div>
      </div>
    </div>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
    <script>
        const apiUrl = `${window.location.origin}`;
        const tokenKey = "whatsappApiToken";

        const qrcodes = {};
        let currentPhoneNumber = ''
        let currentQrTimeOut = ''
        let lastTimeout = undefined
        
        const onBroadcast = function(data) {
          if (data.phone == currentPhoneNumber) {
            const qrcodeDiv = document.getElementById('qrCodeContainer');
            const statusDiv = document.getElementById('qrCodeMessage');
            if (data.type === 'qrcode' && data.content) {
                // Exibe o QR Code
                qrcodeDiv.innerHTML = `<img src="${data.content}" alt="QR Code">`;
                statusDiv.textContent = t('qrScanBelow');
                const timeoutMs =  currentQrTimeOut - (currentQrTimeOut / 5)
                if (lastTimeout) {
                  clearTimeout(lastTimeout);
                }
                lastTimeout = setTimeout(function() {
                  qrcodeDiv.innerHTML = t('qrWaitingNew');
                  qrcodeDiv.textContent = '';
                }, timeoutMs);
            } else if (data.type === 'status' && data.content) {
                if (data.content.toLowerCase().indexOf('connected with')  !== -1) {
                    qrcodeDiv.innerHTML = '';
                    statusDiv.textContent = t('connected');
                } else if (data.content.toLowerCase().indexOf('generate qrcode is exceded')  !== -1) {
                    console.log("QRCODE EXCEEDED")
                    qrcodeDiv.innerHTML = '';
                    statusDiv.textContent = 'Generating new QRCode/PairingCode...';
                    attemptRegister(phoneNumber, localStorage.getItem(tokenKey));
                } else {
                    qrcodeDiv.innerHTML = ''
                    statusDiv.textContent = `Status: ${data.content}`;
                }
            }
          }
        }

        // init websocket 
        function initWebSocket() {
            if (window.socket && window.socket.connected) {
                console.log("WebSocket is already connected.");
                return;
            }
            const socket = io(apiUrl, { path: '/ws' });
            window.socket = socket;
            var lastTimeout = undefined;

            socket.on('broadcast', function(data) {
              if (data.type === 'qrcode' && data.content && data.phone) {
                qrcodes[data.phone] = data.content;
              }
              onBroadcast(data);
            });
        }
        initWebSocket();

        //Logout
        function logout() {
            localStorage.removeItem(tokenKey);
            $('.container').addClass('d-none');
            $('#navbarDropdown').addClass('d-none');
            window.location.reload(); 
        }

        $(document).ready(function () {
            var table;
            const storedToken = localStorage.getItem(tokenKey);

            if (storedToken) {
                fetchSessions(storedToken, true);
            }

            //Login
            $('#connectButton').on('click', function () {
                const token = $('#tokenInput').val().trim();
                if (token) {
                    fetchSessions(token);
                }
            });

            //Add Webhook
            $('#addWebhookButton').on('click', function () {
                const webhookTemplate = `
                    <div class="webhook mb-3">
                        <label for="webhookId" class="form-label" data-i18n="whId">ID</label>
                        <input type="text" class="form-control mb-2 webhook-id" placeholder="Webhook ID" data-i18n-placeholder="whIdPh">
                        <label for="webhookUrl" class="form-label" data-i18n="whUrlAbs">Absolute URL</label>
                        <input type="text" class="form-control mb-2 webhook-url" placeholder="Webhook Absolute URL" data-i18n-placeholder="whUrlAbsPh">
                        <label for="webhookToken" class="form-label" data-i18n="whToken">Token</label>
                        <input type="text" class="form-control mb-2 webhook-token" placeholder="Webhook Token" data-i18n-placeholder="whTokenPh">
                        <label for="webhookHeader" class="form-label" data-i18n="whHeader">Header</label>
                        <input type="text" class="form-control mb-2 webhook-header" placeholder="Webhook Header" data-i18n-placeholder="whHeaderPh">
                        <label for="sendNewMessages" class="form-label" data-i18n="whSendNew">Send New Messages</label>
                        <label class="switch">
                            <input type="checkbox" class="webhook-sendNewMessages">
                            <span class="slider round"></span>
                        </label>
                        <label for="sendGroupMessages" class="form-label" data-i18n="whSendGroup">Send Group Messages</label>
                        <label class="switch">
                            <input type="checkbox" class="webhook-sendGroupMessages">
                            <span class="slider round"></span>
                        </label>
                        <label for="sendNewsletterMessages" class="form-label" data-i18n="whSendNewsletter">Send Newsletter Messages</label>
                        <label class="switch">
                            <input type="checkbox" class="webhook-sendNewsletterMessages">
                            <span class="slider round"></span>
                        </label>
                        <label for="sendOutgoingMessages" class="form-label" data-i18n="whSendOutgoing">Send Outgoing Messages</label>
                        <label class="switch">
                            <input type="checkbox" class="webhook-sendOutgoingMessages">
                            <span class="slider round"></span>
                        </label>
                        <label for="sendIncomingMessages" class="form-label" data-i18n="whSendIncoming">Send Incoming Messages</label>
                        <label class="switch">
                            <input type="checkbox" class="webhook-sendIncomingMessages">
                            <span class="slider round"></span>
                        </label>
                        <label for="sendUpdateMessages" class="form-label" data-i18n="whSendUpdate">Send Message Updates</label>
                        <label class="switch">
                            <input type="checkbox" class="webhook-sendUpdateMessages">
                            <span class="slider round"></span>
                        </label>
                        <label for="sendTranscribeAudio" class="form-label" data-i18n="whSendTranscribe">Send Audio Transcription</label>
                        <label class="switch">
                            <input type="checkbox" class="webhook-sendTranscribeAudio">
                            <span class="slider round"></span>
                        </label>
                        <label for="addToBlackListOnOutgoingMessageWithTtl" class="form-label" data-i18n="whAddBlacklist">Add to blacklist when there is an outgoing message for X seconds</label>
                        <label>
                            <input type="text" class="webhook-addToBlackListOnOutgoingMessageWithTtl" class="form-control">
                        </label>
                        <button type="button" class="btn btn-danger btn-sm mt-2 remove-webhook" data-i18n="remove">Remove</button>
                    </div>`;
                $('#webhooksContainer').append(webhookTemplate);
                try { applyI18n() } catch {}
            });

            $('#webhooksContainer').on('click', '.remove-webhook', function () {
                $(this).closest('.webhook').remove();
            });

            //Create DataTable And Fetch Conected Sessions
            function fetchSessions(token, hideForm = true) {
                if (!$.fn.dataTable.isDataTable('#sessionsTable')) {
                    const dtLang = (currentLang === 'pt-BR') ? {
                        decimal: "",
                        emptyTable: "Nenhuma sessão nesta instalação",
                        info: "Exibindo _START_ até _END_ de _TOTAL_ sessões",
                        infoEmpty: "Nenhum Registro",
                        infoFiltered: "(filtrado de _MAX_ registros no total)",
                        infoPostFix: "",
                        thousands: ".",
                        lengthMenu: "Exibir _MENU_ Sessões",
                        loadingRecords: "Carregando...",
                        processing: "Processando...",
                        search: "Pesquisar:",
                        zeroRecords: "Nenhuma sessão configurada",
                        paginate: {
                            first: "Primeiro",
                            last: "Último",
                            next: "Próximo",
                            previous: "Anterior"
                        },
                        aria: {
                            sortAscending: ": ativar para ordenar a coluna de forma ascendente",
                            sortDescending: ": ativar para ordenar a coluna de forma descendente"
                        }
                    } : {
                        decimal: "",
                        emptyTable: "No sessions on this installation",
                        info: "Showing _START_ to _END_ of _TOTAL_ sessions",
                        infoEmpty: "No records",
                        infoFiltered: "(filtered from _MAX_ total records)",
                        infoPostFix: "",
                        thousands: ",",
                        lengthMenu: "Show _MENU_ sessions",
                        loadingRecords: "Loading...",
                        processing: "Processing...",
                        search: "Search:",
                        zeroRecords: "No sessions configured",
                        paginate: {
                            first: "First",
                            last: "Last",
                            next: "Next",
                            previous: "Previous"
                        },
                        aria: {
                            sortAscending: ": activate to sort column ascending",
                            sortDescending: ": activate to sort column descending"
                        }
                    };
                    table = $('#sessionsTable').DataTable({
                      language: dtLang,
                      responsive: true,
                      autoWidth: false,
                      columnDefs: [
                        { className: 'dtr-control', orderable: false, targets: 0 },
                        { responsivePriority: 1, targets: 0 }, // Label
                        { responsivePriority: 2, targets: 2 }, // Status
                        { responsivePriority: 3, targets: 1 }, // Number
                        { responsivePriority: 4, targets: 3 }, // Server
                        { responsivePriority: 5, targets: 4 }  // Actions
                      ]
                    });
                }
                getSessionAndpopulateTable(token, hideForm)
            }

            // Render status with icon
            function renderStatus(status) {
                var raw = (status || '').toString();
                var s = raw.toLowerCase();
                if (s === 'online') {
                    return `<span class="status status-online" title="${raw}"><span class="dot"></span><span>${raw}</span></span>`;
                }
                if (s === 'offline' || s === 'disconnected') {
                    return `<span class="status status-offline" title="${raw}"><span class="dot"></span><span>${raw}</span></span>`;
                }
                if (s === 'connecting') {
                    return `<span class="status status-connecting" title="${raw}"><span class="dot"></span><span>${raw}</span></span>`;
                }
                if (s === 'standby') {
                    return `<span class="status status-standby" title="${raw}"><span class="dot"></span><span>${raw}</span></span>`;
                }
                if (s === 'restart_required') {
                    return `<span class="status status-restart_required" title="${raw}"><span class="dot"></span><span>${raw}</span></span>`;
                }
                return `<span class="status" title="${raw}"><span class="dot" style="background: var(--muted)"></span><span>${raw}</span></span>`;
            }

            // Populate Datatable with session numbers
            function getSessionAndpopulateTable(token, hideForm) {
                const headers = { Authorization: `Bearer ${token}` };

                fetch(apiUrl + '/sessions', { headers })
                    .then(response => {
                        if (!response.ok) throw new Error(t('errorInvalid'));
                        localStorage.setItem(tokenKey, token);
                        return response.json();
                    })
                    .then(resp => {
                        if (hideForm) {
                            $('#navbarDropdown').removeClass('d-none');
                            $('#login').addClass('d-none');
                        }
                        populateTable(resp.data); // Popula a tabela com os dados
                    })
                    .catch(() => {
                        $('#errorMessage').removeClass('d-none');
                        $('#sessionsTable').addClass('d-none');
                    });
            }

            // Populate Datatable with session numbers
            function populateTable(sessions) {
                $('#errorMessage').addClass('d-none');
                $('#sessionsTable').removeClass('d-none');

                // Limpa os dados antigos da tabela antes de adicionar os novos
                table.clear();

                sessions.forEach(session => {
                    table.row.add([
                        session.label,
                        session.display_phone_number,
                        renderStatus(session.status),
                        session.server,
                        `
                        <button class=\"btn btn-sm btn-warning edit-btn\" data-bs-toggle=\"modal\" data-bs-target=\"#editModal\" data-number=\"${session.display_phone_number}\">\n                            <i class=\"fas fa-edit\"></i> ${t('btnEdit')}\n                        </button>\n                        <button class=\"btn btn-sm btn-success connect-btn\" data-bs-toggle=\"modal\" data-bs-target=\"#connectModal\" data-number=\"${session.display_phone_number}\">\n                            <i class=\"fas fa-link\"></i> ${t('btnConnect')}\n                        </button>\n                        <button class=\"btn btn-sm btn-danger delete-btn\" data-number=\"${session.display_phone_number}\">\n                            <i class=\"fas fa-trash\"></i> ${t('btnDelete')}\n                        </button>\n                        <button class=\"btn btn-sm btn-success message-btn\" data-bs-target=\"#messageModal\" data-number=\"${session.display_phone_number}\">\n                            <i class=\"fas fa-message\"></i> ${t('btnTest')}\n                        </button>`
                    ]).draw(false);
                });
            }

            //deregister function
            $('#sessionsTable tbody').on('click', '.delete-btn', function() {
                if (!confirm(t('confirmDelete'))) {
                    return
                }
                const number = $(this).data('number');
                const token = localStorage.getItem(tokenKey);
                if (token) {
                    fetch(`${apiUrl}/v15.0/${number}/deregister`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            Authorization: `Bearer ${token}`
                        }
                    })
                    .then(response => {
                        if (!response.ok) throw new Error("Erro no request.");
                    })
                    .then(_ => {
                        alert("A sessão foi removida, recarrega a pagina para atualizar a lista!");
                    })
                    .catch(error => alert(error.message));
                }
                
            });

            //Edit button
            $('#sessionsTable tbody').on('click', '.edit-btn', function () {
                const number = $(this).data('number');
                const token = localStorage.getItem(tokenKey);

                if (token) {
                    fetch(`${apiUrl}/v15.0/${number}`, {
                        headers: { Authorization: `Bearer ${token}` }
                    })
                    .then(response => {
                        if (!response.ok) throw new Error("Erro ao buscar dados da sessão.");
                        return response.json();
                    })
                    .then(data => {
                        populateEditForm(data);

                        $('#editModal').data('number', number); 

                        $('#editModal').modal('show');
                    })
                    .catch(error => alert(error.message));
                }
            });

            //Message button
            $('#sessionsTable tbody').on('click', '.message-btn', function () {
                const number = $(this).data('number');
                $('#messageModal').data('number', number); 
                $('#messageModal').modal('show');
            });

            //Edit form for session number
            function populateEditForm(session) {
                $('#label').val(session.label);
                $('#authToken').val(session.authToken);
                $('#wavoipToken').val(session.wavoipToken);
                $('#openaiApiKey').val(session.openaiApiKey);
                $('#openaiApiTranscribeModel').val(session.openaiApiTranscribeModel);
                $('#groqApiKey').val(session.groqApiKey);
                $('#groqApiTranscribeModel').val(session.groqApiTranscribeModel);
                $('#groqApiBaseUrl').val(session.groqApiBaseUrl);
                $('#rejectCallsWebhook').val(session.rejectCallsWebhook);
                $('#rejectCalls').val(session.rejectCalls);
                $('#ignoreGroupMessages').prop('checked', session.ignoreGroupMessages);
                $('#ignoreNewsletterMessages').prop('checked', session.ignoreNewsletterMessages);
                $('#ignoreHistoryMessages').prop('checked', session.ignoreHistoryMessages);
                $('#readOnReceipt').prop('checked', session.readOnReceipt);
                $('#sendProfilePicture').prop('checked', session.sendProfilePicture);
                $('#ignoreOwnMessages').prop('checked', session.ignoreOwnMessages);
                $('#ignoreYourselfMessages').prop('checked', session.ignoreYourselfMessages);
                $('#ignoreBroadcastStatuses').prop('checked', session.ignoreBroadcastStatuses);
                $('#sendConnectionStatus').prop('checked', session.sendConnectionStatus);
                $('#notifyFailedMessages').prop('checked', session.notifyFailedMessages);
                $('#composingMessage').prop('checked', session.composingMessage);
                $('#sendReactionAsReply').prop('checked', session.sendReactionAsReply);
                $('#autoConnect').prop('checked', session.autoConnect);
                $('#ignoreBroadcastMessages').prop('checked', session.ignoreBroadcastMessages);
                $('#connectionType').val(session.connectionType);
                $('#proxyUrl').val(session.proxyUrl);
                $('#server').val(session.server);
                // Rate limits (anti-spam)
                try {
                  $('#rateLimitGlobalPerMinute').val(session.rateLimitGlobalPerMinute ?? 0);
                  $('#rateLimitPerToPerMinute').val(session.rateLimitPerToPerMinute ?? 0);
                  $('#rateLimitBlockSeconds').val(session.rateLimitBlockSeconds ?? 60);
                } catch (e) {}

                // Limpar webhooks existentes no formulário de edição
                $('#webhooksContainer .webhook').remove();

                if (session.webhooks && Array.isArray(session.webhooks)) {
                    session.webhooks.forEach(webhook => {
                        const webhookTemplate = `
                            <div class=\"webhook mb-3\">
                                <label for=\"webhookId\" class=\"form-label\" data-i18n=\"whId\">ID</label>
                                <input type=\"text\" class=\"form-control mb-2 webhook-id\" value=\"${webhook.id}\" placeholder=\"Webhook ID\" data-i18n-placeholder=\"whIdPh\">
                                <label for=\"webhookUrl\" class=\"form-label\" data-i18n=\"whUrlAbs\">Absolute URL</label>
                                <input type=\"text\" class=\"form-control mb-2 webhook-url\" value=\"${webhook.urlAbsolute}\" placeholder=\"Webhook Absolute URL\" data-i18n-placeholder=\"whUrlAbsPh\">
                                <label for=\"webhookToken\" class=\"form-label\" data-i18n=\"whToken\">Token</label>
                                <input type=\"text\" class=\"form-control mb-2 webhook-token\" value=\"${webhook.token}\" placeholder=\"Webhook Token\" data-i18n-placeholder=\"whTokenPh\">
                                <label for=\"webhookHeader\" class=\"form-label\" data-i18n=\"whHeader\">Header</label>
                                <input type=\"text\" class=\"form-control mb-2 webhook-header\" value=\"${webhook.header}\" placeholder=\"Webhook Header\" data-i18n-placeholder=\"whHeaderPh\">
                                <label for=\"sendNewMessages\" class=\"form-label\" data-i18n=\"whSendNew\">Send New Messages</label>
                                <label class="switch">
                                    <input type="checkbox" class="webhook-sendNewMessages" ${webhook.sendNewMessages ? 'checked' : ''}>
                                    <span class="slider round"></span>
                                </label>
                                <label for=\"sendGroupMessages\" class=\"form-label\" data-i18n=\"whSendGroup\">Send Group Messages</label>
                                <label class="switch">
                                    <input type="checkbox" class="webhook-sendGroupMessages" ${webhook.sendGroupMessages ? 'checked' : ''}>
                                    <span class="slider round"></span>
                                </label>
                                <label for=\"sendNewsletterMessages\" class=\"form-label\" data-i18n=\"whSendNewsletter\">Send Newsletter Messages</label>
                                <label class="switch">
                                    <input type="checkbox" class="webhook-sendNewsletterMessages" ${webhook.sendNewsletterMessages ? 'checked' : ''}>
                                    <span class="slider round"></span>
                                </label>
                                <label for=\"sendOutgoingMessages\" class=\"form-label\" data-i18n=\"whSendOutgoing\">Send Outgoing Messages</label>
                                <label class="switch">
                                    <input type="checkbox" class="webhook-sendOutgoingMessages" ${webhook.sendOutgoingMessages ? 'checked' : ''}>
                                    <span class="slider round"></span>
                                </label>
                                <label for=\"sendIncomingMessages\" class=\"form-label\" data-i18n=\"whSendIncoming\">Send Incoming Messages</label>
                                <label class="switch">
                                    <input type="checkbox" class="webhook-sendIncomingMessages" ${webhook.sendIncomingMessages ? 'checked' : ''}>
                                    <span class="slider round"></span>
                                </label>
                                <label for=\"sendUpdateMessages\" class=\"form-label\" data-i18n=\"whSendUpdate\">Send Message Updates</label>
                                <label class="switch">
                                    <input type="checkbox" class="webhook-sendUpdateMessages" ${webhook.sendUpdateMessages ? 'checked' : ''}>
                                    <span class="slider round"></span>
                                </label>
                                <label for=\"sendTranscribeAudio\" class=\"form-label\" data-i18n=\"whSendTranscribe\">Send Audio Transcription</label>
                                <label class="switch">
                                    <input type="checkbox" class="webhook-sendTranscribeAudio" ${webhook.sendTranscribeAudio ? 'checked' : ''}>
                                    <span class="slider round"></span>
                                </label>
                                <label for=\"addToBlackListOnOutgoingMessageWithTtl\" class=\"form-label\" data-i18n=\"whAddBlacklist\">Add to blacklist when there is an outgoing message for X seconds</label>
                                <label>
                                    <input type="text" class="webhook-addToBlackListOnOutgoingMessageWithTtl" value="${webhook.addToBlackListOnOutgoingMessageWithTtl || ''}" class="form-control">
                                </label>
                                <button type="button" class="btn btn-danger btn-sm mt-2 remove-webhook" data-i18n=\"remove\">Remove</button>
                            </div>`;
                        $('#webhooksContainer').append(webhookTemplate);
                        try { applyI18n() } catch {}
                    });
                }
            }

            //Save/set configs
            $('#saveEditButton').on('click', function () {
                const token = localStorage.getItem(tokenKey);
                const number = $('#editModal').data('number');

                if (token && number) {
                    const sessionData = {
                        label: $('#label').val(),
                        authToken: $('#authToken').val(),
                        wavoipToken: $('#wavoipToken').val(),
                        openaiApiKey: $('#openaiApiKey').val(),
                        openaiApiTranscribeModel: $('#openaiApiTranscribeModel').val(),
                        groqApiKey: $('#groqApiKey').val(),
                        groqApiTranscribeModel: $('#groqApiTranscribeModel').val(),
                        groqApiBaseUrl: $('#groqApiBaseUrl').val(),
                        rejectCalls: $('#rejectCalls').val(),
                        rejectCallsWebhook: $('#rejectCallsWebhook').val(),
                        ignoreGroupMessages: $('#ignoreGroupMessages').is(':checked'),
                        ignoreNewsletterMessages: $('#ignoreNewsletterMessages').is(':checked'),
                        ignoreHistoryMessages: $('#ignoreHistoryMessages').is(':checked'),
                        readOnReceipt: $('#readOnReceipt').is(':checked'),
                        sendProfilePicture: $('#sendProfilePicture').is(':checked'),
                        ignoreOwnMessages: $('#ignoreOwnMessages').is(':checked'),
                        ignoreYourselfMessages: $('#ignoreYourselfMessages').is(':checked'),
                        sendConnectionStatus: $('#sendConnectionStatus').is(':checked'),
                        ignoreBroadcastStatuses: $('#ignoreBroadcastStatuses').is(':checked'),
                        notifyFailedMessages: $('#notifyFailedMessages').is(':checked'),
                        composingMessage: $('#composingMessage').is(':checked'),
                        sendReactionAsReply: $('#sendReactionAsReply').is(':checked'),
                        autoConnect: $('#autoConnect').is(':checked'),
                        ignoreBroadcastMessages: $('#ignoreBroadcastMessages').is(':checked'),
                        connectionType: $('#connectionType').val(),
                        proxyUrl: $('#proxyUrl').val(),
                        server: $('#server').val(),
                        // rate limits
                        rateLimitGlobalPerMinute: Number($('#rateLimitGlobalPerMinute').val() || 0),
                        rateLimitPerToPerMinute: Number($('#rateLimitPerToPerMinute').val() || 0),
                        rateLimitBlockSeconds: Number($('#rateLimitBlockSeconds').val() || 60),
                        webhooks: []
                    };

                    $('#webhooksContainer .webhook').each(function () {
                        const webhook = {
                            id: $(this).find('.webhook-id').val(),
                            urlAbsolute: $(this).find('.webhook-url').val(),
                            token: $(this).find('.webhook-token').val(),
                            header: $(this).find('.webhook-header').val(),
                            sendNewMessages: $(this).find('.webhook-sendNewMessages').is(':checked'),
                            sendGroupMessages: $(this).find('.webhook-sendGroupMessages').is(':checked'),
                            sendNewsletterMessages: $(this).find('.webhook-sendNewsletterMessages').is(':checked'),
                            sendOutgoingMessages: $(this).find('.webhook-sendOutgoingMessages').is(':checked'),
                            sendIncomingMessages: $(this).find('.webhook-sendIncomingMessages').is(':checked'),
                            sendUpdateMessages: $(this).find('.webhook-sendUpdateMessages').is(':checked'),
                            sendTranscribeAudio: $(this).find('.webhook-sendTranscribeAudio').is(':checked'),
                            addToBlackListOnOutgoingMessageWithTtl: $(this).find('.webhook-addToBlackListOnOutgoingMessageWithTtl').val(),
                        };
                        sessionData.webhooks.push(webhook);
                    });
                    sessionData.overrideWebhooks = true
                    fetch(`${apiUrl}/v15.0/${number}/register`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            Authorization: `Bearer ${token}`
                        },
                        body: JSON.stringify(sessionData)
                    })
                    .then(response => {
                        if (!response.ok) throw new Error(t('errorInvalid'));
                        return response.json();
                    })
                    .then(() => {
                        $('#editModal').modal('hide');
                        fetchSessions(token, true);
                    })
                    .catch(error => alert(error.message));
                }
            });

            //QRCODE AND CONNECT

            //connectButton
            $(document).on('click', '.connect-btn', function () {
                const number = $(this).data('number');
                const token = localStorage.getItem(tokenKey);

                if (token) {
                    fetch(`${apiUrl}/v15.0/${number}`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    })
                    .then(response => {
                        if (!response.ok) throw new Error(t('errorInvalid'));
                        return response.json();
                    })
                    .then(data => {
                        if (data.status === 'offline' || data.status === 'disconnected') {
                            attemptRegister(number, token);
                        } else if (data.status === 'connecting') {
                            connectToWebSocket(number, data.qrTimeoutMs);
                        } else if (data.status === 'online') {
                            document.getElementById('qrCodeContainer').innerHTML = '';
                            document.getElementById('qrCodeMessage').textContent = t('connected');
                        } else {
                            console.log("Status not offline nor connecting.");
                        }
                    })
                    .catch(error => {
                        console.error("Erro ao verificar status:", error);
                    });
                } else {
                    alert(t('tokenNotFound'));
                }
            });

            // init qrcode and confirm
            function attemptRegister(number, token) {
                fetch(`${apiUrl}/v15.0/${number}/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        Authorization: `Bearer ${token}`
                    }
                })
                .then(response => {
                    if (!response.ok) throw new Error('Error');
                    return response.json();
                })
                .then((data) => {
                    checkStatusAndRetry(number, token, data.qrTimeoutMs);
                })
                .catch(error => {
                    alert(error.message);
                });
            }

            // check connecting status
            function checkStatusAndRetry(number, token, qrTimeoutMs) {
                let attempts = 0;
                const maxAttempts = 3;
                connectToWebSocket(number, qrTimeoutMs);

                const intervalId = setInterval(() => {
                    fetch(`${apiUrl}/v15.0/${number}`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    })
                    .then(response => {
                        if (!response.ok) throw new Error("Erro de Sessão.");
                        return response.json();
                    })
                    .then(data => {
                        if (data.status === 'connecting') {
                            clearInterval(intervalId);
                        } else if (attempts < maxAttempts && data.status !== 'connecting') {
                            attempts++;
                            fetch(`${apiUrl}/v15.0/${number}/register`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    Authorization: `Bearer ${token}`
                                }
                            })
                            .catch(error => {
                                clearInterval(intervalId);
                                alert(error.message);
                            });
                        } else {
                            clearInterval(intervalId);
                            console.log(t('apiNoQr'));
                        }
                    })
                    .catch(error => {
                        console.error("Erro ao verificar status:", error);
                    });
                }, 3000); 
            }

            // conect to websocket 
            function connectToWebSocket(phoneNumber, qrTimeoutMs) {
              currentPhoneNumber = phoneNumber
              currentQrTimeOut = qrTimeoutMs
              if (qrcodes[phoneNumber]) {
                const qrcodeDiv = document.getElementById('qrCodeContainer');
                qrcodeDiv.innerHTML = `<img src="${qrcodes[phoneNumber]}" alt="QR Code">`;
              }
            }

            // disconnect websocket on modal close
            $('#connectModal').on('hidden.bs.modal', function () {
              currentPhoneNumber = ''
              currentQrTimeOut = ''
              document.getElementById('qrCodeContainer').innerHTML = '';
                    document.getElementById('qrCodeMessage').textContent = t('qrWait');
            });            
        });
        

        // show number add modal
        function addInstance() {
            const addInstanceModal = new bootstrap.Modal(document.getElementById('addInstanceModal'));
            addInstanceModal.show();
        }

        function submitInstanceNumber() {
            const numberInput = document.getElementById('instanceNumber').value;

            if (numberInput) {
                const editModal = $('#editModal'); 
                editModal.data('number', numberInput); 

                bootstrap.Modal.getInstance(document.getElementById('addInstanceModal')).hide();

                const editInstanceModal = new bootstrap.Modal(document.getElementById('editModal'));
                editInstanceModal.show();

            } else {
                alert(currentLang==='pt-BR' ? 'Por favor, insira um número válido.' : 'Please enter a valid number.');
            }
        }

        function submitMessage() {
            const numberInput = document.getElementById('messageModalNumber').value;
            const messageInput = document.getElementById('messageModalText').value;
            const token = localStorage.getItem(tokenKey);
            if (numberInput && messageInput) {
                const headers = { 
                  Authorization: `Bearer ${token}`,
                  'Content-Type': 'application/json',
                };
                const number = $('#messageModal').data('number');
                const body = JSON.stringify({
                  messaging_product: 'whatsapp',
                  to: numberInput,
                  type: 'text',
                  text: {
                    body: messageInput
                  } 
                })
                fetch(apiUrl + '/v15.0/' + number + '/messages', { method: 'POST', headers, body })
            } else {
                alert(currentLang==='pt-BR' ? 'Por favor, insira um número válido e a mensagem para enviar.' : 'Please enter a valid number and the message to send.');
            }
        }
    </script>
</body>
</html>
